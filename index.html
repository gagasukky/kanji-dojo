<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>漢字マスター道場・極</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (JSX変換用) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind 設定 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'fadeIn': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: 0, transform: 'translateY(10px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f5f5f4; font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- アイコンコンポーネント (Lucide代替) ---
        const Icon = ({ path, size = 24, className = "", fill = "none" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const BookOpen = (p) => <Icon {...p} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />;
        const Puzzle = (p) => <Icon {...p} path={<path d="M19.439 15.435a4.06 4.06 0 0 0-3.376 1.933l-.117.188c-1.348 2.164-4.524 2.164-5.872 0l-.117-.188a4.06 4.06 0 0 0-3.376-1.933 4.048 4.048 0 0 0-2.457.838 1 1 0 0 1-1.286-1.572 6.048 6.048 0 0 1 3.743-1.266 6.06 6.06 0 0 1 5.042 2.89l.117.189c.337.54.993.54 1.33 0l.117-.189a6.06 6.06 0 0 1 5.042-2.89 6.048 6.048 0 0 1 3.743 1.266 1 1 0 0 1-1.286 1.572 4.048 4.048 0 0 0-2.348-.838Z"/>} />;
        const Trophy = (p) => <Icon {...p} path={<><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></>} />;
        const ArrowRight = (p) => <Icon {...p} path={<><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></>} />;
        const RefreshCcw = (p) => <Icon {...p} path={<><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></>} />;
        const Star = (p) => <Icon {...p} fill={p.fill === "currentColor" ? "currentColor" : "none"} path={<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>} />;
        const CheckCircle = (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
        const XCircle = (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></>} />;
        const Home = (p) => <Icon {...p} path={<><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>} />;
        const GraduationCap = (p) => <Icon {...p} path={<><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></>} />;

        // --- データセット (圧縮版) ---
        const COMPRESSED_DATA = [
            // 1年生
            "1|一|いち|ひとつ|", "1|右|みぎ|右手|ナ口", "1|雨|あめ|天候|", "1|円|えん|丸い|", "1|王|おう|王様|", 
            "1|音|おと|響き|立日", "1|下|した|低い|", "1|火|ひ|炎|", "1|花|はな|植物|艹イヒ", "1|貝|かい|海産物|目ハ", 
            "1|学|まなぶ|勉強|", "1|気|き|気持ち|", "1|九|きゅう|数字|", "1|休|やすむ|休憩|イ木", "1|玉|たま|宝石|王丶", 
            "1|金|きん|お金|", "1|空|そら|天空|ウ八工", "1|月|つき|衛星|", "1|犬|いぬ|動物|大丶", "1|見|みる|視覚|", 
            "1|五|ご|数字|", "1|口|くち|体の一部|", "1|校|こう|学校|木交", "1|左|ひだり|左手|ナ工", "1|三|さん|数字|", 
            "1|山|やま|自然|", "1|子|こ|子供|", "1|四|し|数字|", "1|糸|いと|繊維|", "1|字|じ|文字|ウ子", 
            "1|耳|みみ|器官|", "1|七|しち|数字|", "1|車|くるま|乗り物|", "1|手|て|体の一部|", "1|十|じゅう|数字|", 
            "1|出|でる|外へ|", "1|女|おんな|女性|", "1|小|ちいさい|サイズ|", "1|上|うえ|高い|", "1|森|もり|森林|木木木", 
            "1|人|ひと|人間|", "1|水|みず|液体|", "1|正|ただしい|正解|", "1|生|いきる|生命|", "1|青|あお|色|生月", 
            "1|夕|ゆう|夕方|", "1|石|いし|鉱物|", "1|赤|あか|色|土ハハ", "1|千|せん|数字|", "1|川|かわ|流れ|", 
            "1|先|さき|以前|", "1|早|はやい|時間|日十", "1|草|くさ|植物|艹早", "1|足|あし|体の一部|", "1|村|むら|郷|木寸", 
            "1|大|おおきい|サイズ|", "1|男|おとこ|男性|田力", "1|竹|たけ|植物|", "1|中|なか|内部|", "1|虫|むし|昆虫|", 
            "1|町|まち|街|田丁", "1|天|てん|空|", "1|田|た|農地|", "1|土|つち|土壌|", "1|二|に|数字|", 
            "1|日|ひ|太陽|", "1|入|はいる|内へ|", "1|年|とし|歳|", "1|白|しろ|色|", "1|八|はち|数字|", 
            "1|百|ひゃく|数字|", "1|文|ぶん|文字|", "1|木|き|樹木|", "1|本|ほん|書物|", "1|名|な|名前|タ口", 
            "1|目|め|器官|", "1|立|たつ|直立|", "1|力|ちから|パワー|", "1|林|はやし|林|木木", "1|六|ろく|数字|",

            // 2年生
            "2|引|ひく|引っ張る|", "2|羽|はね|翼|", "2|雲|くも|天候|雨云", "2|園|その|庭|囗元", "2|遠|とおい|距離|辶袁", 
            "2|何|なに|疑問|イ可", "2|科|か|科学|禾斗", "2|夏|なつ|季節|", "2|家|いえ|住居|ウ豕", "2|歌|うた|歌唱|可可欠", 
            "2|画|が|絵画|", "2|回|かい|回転|囗口", "2|会|あう|面会|", "2|海|うみ|海洋|氵毎", "2|絵|え|絵画|糸会", 
            "2|外|そと|外部|タト", "2|角|かく|角度|", "2|楽|たのしい|快楽|白木冫冫", "2|活|かつ|活動|氵舌", "2|間|あいだ|間隔|門日", 
            "2|丸|まる|円形|", "2|岩|いわ|巨石|山石", "2|顔|かお|面|彦頁", "2|汽|き|蒸気|氵气", "2|記|き|記録|言己", 
            "2|帰|かえる|帰宅|", "2|弓|ゆみ|武器|", "2|牛|うし|動物|", "2|魚|さかな|魚類|", "2|京|きょう|都|", 
            "2|強|つよい|強力|弓ム虫", "2|教|おしえる|教育|孝攵", "2|近|ちかい|距離|辶斤", "2|兄|あに|兄弟|口儿", "2|形|かたち|形状|開彡", 
            "2|計|はかる|計算|言十", "2|元|もと|起源|", "2|言|いう|言葉|", "2|原|はら|野原|", "2|戸|と|扉|", 
            "2|古|ふるい|過去|十口", "2|午|ご|正午|", "2|後|あと|後ろ|彳幺夂", "2|語|ご|言語|言吾", "2|工|こう|工作|", 
            "2|公|こう|公共|ハム", "2|広|ひろい|広大|", "2|交|まじわる|交代|", "2|光|ひかり|光線|", "2|考|かんがえる|思考|", 
            "2|行|いく|移動|", "2|高|たかい|高さ|", "2|黄|き|色|", "2|合|あう|合致|", "2|谷|たに|地形|ハ人口", 
            "2|国|くに|国家|囗玉", "2|黒|くろ|色|里灬", "2|今|いま|現在|", "2|才|さい|才能|", "2|細|ほそい|詳細|糸田", 
            "2|作|つくる|工作|イ乍", "2|算|さん|計算|竹目廾", "2|止|とまる|停止|", "2|市|し|都市|", "2|矢|や|武器|", 
            "2|姉|あね|姉妹|女市", "2|思|おもう|思考|田心", "2|紙|かみ|用紙|糸氏", "2|寺|てら|寺院|土寸", "2|自|みずから|自分|", 
            "2|時|とき|時間|日寺", "2|室|しつ|部屋|ウ至", "2|社|しゃ|社会|ネ土", "2|弱|よわい|弱い|弓冫弓冫", "2|首|くび|体|", 
            "2|秋|あき|季節|禾火", "2|週|しゅう|週間|辶周", "2|春|はる|季節|三人日", "2|書|かく|書く|聿日", "2|少|すくない|量|", 
            "2|場|ば|場所|土昜", "2|色|いろ|色彩|", "2|食|たべる|食事|", "2|心|こころ|心臓|", "2|新|あたらしい|新規|立木斤", 
            "2|親|おや|親子|立木見", "2|図|ず|図面|囗メ", "2|数|かず|数字|", "2|西|にし|方角|", "2|声|こえ|音声|", 
            "2|星|ほし|天体|日生", "2|晴|はれる|天気|日青", "2|切|きる|切断|七刀", "2|雪|ゆき|天気|雨ヨ", "2|船|ふね|船舶|舟八口", 
            "2|線|せん|ライン|糸泉", "2|前|まえ|前方|", "2|組|くみ|組織|糸且", "2|走|はしる|走行|", "2|多|おおい|量|夕夕", 
            "2|太|ふとい|太い|大丶", "2|体|からだ|身体|イ本", "2|台|だい|台座|ム口", "2|地|ち|地面|土也", "2|池|いけ|水溜り|氵也", 
            "2|知|しる|知識|矢口", "2|茶|ちゃ|茶葉|艹ホ", "2|昼|ひる|昼間|尺旦", "2|長|ながい|長さ|", "2|鳥|とり|動物|", 
            "2|朝|あさ|午前|十早月", "2|直|なおす|直接|", "2|通|とおる|通過|辶マ用", "2|弟|おとうと|兄弟|", "2|店|みせ|店舗|广占", 
            "2|点|てん|得点|黒灬", "2|電|でん|電気|雨田", "2|刀|かたな|武器|", "2|冬|ふゆ|季節|夂冫", "2|当|あたる|当然|", 
            "2|東|ひがし|方角|", "2|答|こたえ|返答|竹合", "2|頭|あたま|頭部|豆頁", "2|同|おなじ|同一|", "2|道|みち|道路|辶首", 
            "2|読|よむ|読書|言売", "2|内|うち|内部|", "2|南|みなみ|方角|", "2|肉|にく|食品|", "2|馬|うま|動物|", 
            "2|売|うる|販売|士冖儿", "2|買|かう|購買|罒貝", "2|麦|むぎ|穀物|", "2|半|はん|半分|", "2|番|ばん|順番|釆田", 
            "2|父|ちち|父親|", "2|風|かぜ|気候|", "2|分|わける|分割|八刀", "2|聞|きく|聴覚|門耳", "2|米|こめ|穀物|", 
            "2|歩|あるく|歩行|止少", "2|母|はは|母親|", "2|方|ほう|方向|", "2|北|きた|方角|", "2|毎|まい|毎回|", 
            "2|妹|いもうと|姉妹|女未", "2|万|まん|数字|", "2|明|あかるい|明暗|日月", "2|鳴|なく|鳴き声|口鳥", "2|毛|け|体毛|", 
            "2|門|もん|ゲート|", "2|夜|よる|夜間|", "2|野|の|原野|里予", "2|友|とも|友達|", "2|用|よう|使用|", 
            "2|曜|よう|曜日|日ヨヨ隹", "2|来|くる|未来|", "2|里|さと|里|", "2|理|り|理由|王里", "2|話|はなし|会話|言舌",

            // 3年生
            "3|悪|わるい|善悪|", "3|安|やすい|安心|ウ女", "3|暗|くらい|暗闇|日音", "3|医|い|医者|匚矢", "3|委|い|委任|禾女",
            "3|意|い|意味|音心", "3|育|そだつ|育成|", "3|員|いん|社員|口貝", "3|院|いん|病院|阝完", "3|飲|のむ|飲食|食欠",
            "3|運|はこぶ|運搬|辶軍", "3|泳|およぐ|水泳|氵永", "3|駅|えき|鉄道|馬尺", "3|央|おう|中央|", "3|横|よこ|側面|木黄",
            "3|屋|や|屋根|尸至", "3|温|あたたかい|温度|氵皿日", "3|化|か|変化|イヒ", "3|荷|に|荷物|艹何", "3|界|かい|世界|田介",
            "3|開|ひらく|開始|門鳥", "3|階|かい|階段|阝皆", "3|寒|さむい|寒冷|ウ井冫", "3|感|かん|感情|咸心", "3|漢|かん|漢字|氵 漢",
            "3|館|かん|建物|食官", "3|岸|きし|海岸|山干", "3|起|おきる|起床|走己", "3|期|き|期間|其月", "3|客|きゃく|客|ウ各",
            "3|究|きゅう|研究|ウ九", "3|急|いそぐ|急用|", "3|級|きゅう|等級|糸及", "3|宮|みや|宮殿|ウ呂", "3|球|たま|球体|王求",
            "3|去|さる|過去|", "3|橋|はし|架け橋|木喬", "3|業|ぎょう|業務|", "3|曲|まがる|曲線|", "3|局|きょく|部局|",
            "3|銀|ぎん|金属|金艮", "3|区|く|区域|", "3|苦|くるしい|苦痛|艹古", "3|具|ぐ|道具|目八", "3|君|きみ|君主|",
            "3|係|かかり|関係|イ系", "3|軽|かるい|軽量|車圣", "3|血|ち|血液|", "3|決|きめる|決定|氵夬", "3|研|けん|研究|石开",
            "3|県|けん|県|", "3|庫|こ|倉庫|广車", "3|湖|みずうみ|湖|氵胡", "3|向|むかう|方向|", "3|幸|しあわせ|幸福|",
            "3|港|みなと|港|氵巷", "3|号|ごう|番号|", "3|根|ね|根っこ|木艮", "3|祭|まつり|祭礼|月又示", "3|皿|さら|食器|",
            "3|仕|し|仕事|イ士", "3|死|しぬ|死亡|", "3|使|つかう|使用|イ吏", "3|始|はじめる|開始|女台", "3|指|ゆび|指|扌旨",
            "3|歯|は|歯|", "3|詩|し|詩|言寺", "3|次|つぎ|次回|", "3|事|こと|事情|", "3|持|もつ|所持|扌寺",
            "3|式|しき|方式|", "3|実|じつ|真実|ウ头", "3|写|うつす|写真|ウ与", "3|者|もの|人物|", "3|主|ぬし|主人|",
            "3|守|まもる|守備|ウ寸", "3|取|とる|取得|耳又", "3|酒|さけ|酒|氵酉", "3|受|うける|受信|", "3|州|しゅう|州|",
            "3|拾|ひろう|拾得|扌合", "3|終|おわる|終了|糸冬", "3|習|ならう|学習|羽白", "3|集|あつめる|集合|隹木", "3|住|すむ|住所|イ主",
            "3|重|おもい|重量|", "3|宿|やど|宿|ウイ百", "3|所|ところ|場所|戸斤", "3|暑|あつい|暑い|日者", "3|助|たすける|救助|且力",
            "3|昭|しょう|昭和|日召", "3|消|きえる|消化|氵肖", "3|商|しょう|商業|", "3|章|しょう|文章|音十", "3|勝|かつ|勝利|月券",
            "3|乗|のる|乗車|", "3|植|うえる|植物|木直", "3|申|もうす|申請|", "3|身|み|身体|", "3|神|かみ|神様|ネ申",
            "3|真|しん|真実|", "3|深|ふかい|深刻|氵木", "3|進|すすむ|進行|辶隹", "3|世|よ|世界|", "3|整|ととのう|整理|束攵正",
            "3|昔|むかし|昔話|", "3|全|ぜん|全部|入王", "3|相|そう|相手|木目", "3|送|おくる|送信|辶关", "3|想|おもう|想像|相心",
            "3|息|いき|呼吸|自心", "3|速|はやい|速度|辶束", "3|族|ぞく|家族|方矢", "3|他|た|他人|イ也", "3|打|うつ|打撃|扌丁",
            "3|対|たい|対立|文寸", "3|待|まつ|待機|彳寺", "3|代|だい|代理|イ弋", "3|第|だい|第一|竹弟", "3|題|だい|問題|是頁",
            "3|炭|たん|石炭|山灰", "3|短|みじかい|短縮|矢豆", "3|談|だん|相談|言炎", "3|着|きる|到着|", "3|注|ちゅう|注意|氵主",
            "3|柱|はしら|柱|木主", "3|丁|ちょう|丁寧|", "3|帳|ちょう|手帳|巾長", "3|調|しらべる|調査|言周", "3|追|おう|追跡|辶",
            "3|定|てい|定規|ウ正", "3|庭|にわ|庭|广廷", "3|笛|ふえ|笛|竹由", "3|鉄|てつ|鉄|金失", "3|転|ころぶ|回転|車云",
            "3|都|みやこ|都市|者阝", "3|度|ど|温度|", "3|投|なげる|投手|扌殳", "3|豆|まめ|大豆|", "3|島|しま|島|鳥山",
            "3|湯|ゆ|お湯|氵昜", "3|登|のぼる|登山|", "3|等|ひとしい|平等|竹寺", "3|動|うごく|動物|重力", "3|童|わらべ|童話|立里",
            "3|農|のう|農業|曲辰", "3|波|なみ|波|氵皮", "3|配|くばる|心配|酉己", "3|倍|ばい|倍|イ立口", "3|箱|はこ|箱|竹相",
            "3|畑|はたけ|畑|火田", "3|発|はつ|出発|", "3|反|はん|反対|", "3|坂|さか|坂道|土反", "3|板|いた|板|木反",
            "3|皮|かわ|皮膚|", "3|悲|かなしい|悲劇|非心", "3|美|うつくしい|美人|羊大", "3|鼻|はな|鼻|", "3|筆|ふで|筆|竹聿",
            "3|氷|こおり|氷|", "3|表|ひょう|発表|", "3|秒|びょう|秒|禾少", "3|病|やまい|病気|疒丙", "3|品|ひん|品物|口口口",
            "3|負|まける|勝負|", "3|部|ぶ|部屋|立口阝", "3|服|ふく|衣服|月", "3|福|ふく|幸福|ネ畐", "3|物|もの|物体|牛勿",
            "3|平|へい|平和|", "3|返|かえす|返事|辶反", "3|勉|べん|勉強|免力", "3|放|はなす|放送|方攵", "3|味|あじ|味|口未",
            "3|命|いのち|生命|", "3|面|めん|表面|", "3|問|とい|問題|門口", "3|役|やく|役割|彳殳", "3|薬|くすり|薬|艹楽",
            "3|由|ゆう|自由|", "3|油|あぶら|石油|氵由", "3|有|ある|有無|", "3|遊|あそぶ|遊び|辶方子", "3|予|よ|予定|",
            "3|羊|ひつじ|動物|", "3|洋|よう|海洋|氵羊", "3|葉|は|葉っぱ|艹世木", "3|陽|よう|太陽|阝昜", "3|様|さま|様子|木羊永",
            "3|落|おちる|落下|艹氵各", "3|流|ながれる|流行|氵", "3|旅|たび|旅行|方氏", "3|両|りょう|両方|", "3|緑|みどり|緑色|糸录",
            "3|礼|れい|お礼|ネL", "3|列|れつ|行列|", "3|練|れん|練習|糸東", "3|路|みち|道路|足各", "3|和|わ|平和|禾口",

            // 4年生
            "4|愛|あい|愛情|", "4|案|あん|案内|安木", "4|以|い|以上|", "4|衣|い|衣服|", "4|位|い|順位|イ立",
            "4|囲|かこむ|周囲|囗井", "4|胃|い|胃|田月", "4|印|いん|印|", "4|英|えい|英語|艹央", "4|栄|えい|栄養|",
            "4|塩|しお|食塩|土人口皿", "4|億|おく|億|イ意", "4|加|か|参加|力口", "4|貨|か|貨物|化貝", "4|課|か|課題|言果",
            "4|芽|め|発芽|艹牙", "4|改|かい|改正|己攵", "4|械|かい|機械|木戒", "4|害|がい|公害|", "4|街|まち|市街|行土土",
            "4|各|かく|各自|夂口", "4|覚|おぼえる|感覚|", "4|完|かん|完成|ウ元", "4|官|かん|官庁|", "4|管|かん|管理|竹官",
            "4|関|かん|関係|門关", "4|観|かん|観察|", "4|願|ねがう|願望|原頁", "4|希|き|希望|", "4|季|き|季節|禾子",
            "4|紀|き|世紀|糸己", "4|喜|よろこぶ|喜劇|吉", "4|旗|はた|国旗|方其", "4|器|き|食器|口口犬口口", "4|機|き|機械|木幾",
            "4|議|ぎ|会議|言義", "4|求|もとめる|要求|", "4|泣|なく|号泣|氵立", "4|救|すくう|救助|求攵", "4|給|きゅう|給食|糸合",
            "4|挙|きょ|選挙|", "4|漁|ぎょ|漁業|氵魚", "4|共|きょう|共同|", "4|協|きょう|協力|十力力力", "4|鏡|かがみ|鏡|金竟",
            "4|競|きょう|競争|立立兄兄", "4|極|きょく|南極|木亟", "4|訓|くん|訓練|言川", "4|軍|ぐん|軍隊|車冖", "4|郡|ぐん|郡|君阝",
            "4|径|けい|直径|彳圣", "4|型|かた|模型|刑土", "4|景|けい|景色|日京", "4|芸|げい|芸術|艹云", "4|欠|けつ|欠席|",
            "4|結|けつ|結果|糸吉", "4|建|たてる|建設|廴聿", "4|健|けん|健康|イ建", "4|験|けん|試験|馬僉", "4|固|こ|固体|囗古",
            "4|功|こう|成功|工力", "4|好|すき|好物|女子", "4|候|こう|天候|イ|", "4|航|こう|航空|舟亢", "4|康|こう|健康|广隶",
            "4|告|こく|報告|牛口", "4|差|さ|差別|", "4|菜|さい|野菜|艹采", "4|最|さい|最初|日取", "4|材|ざい|材料|木才",
            "4|昨|さく|昨日|日乍", "4|札|さつ|名札|木L", "4|刷|さつ|印刷|", "4|殺|さつ|殺菌|", "4|察|さつ|警察|ウ祭",
            "4|参|さん|参加|ム大彡", "4|産|さん|産業|", "4|散|さん|散歩|", "4|残|ざん|残念|歹戋", "4|士|し|武士|",
            "4|氏|し|氏名|", "4|史|し|歴史|口X", "4|司|し|司会|", "4|試|し|試験|言式", "4|児|じ|児童|旧儿",
            "4|治|じ|政治|氵台", "4|辞|じ|辞書|舌辛", "4|失|しつ|失敗|", "4|借|かりる|借金|イ昔", "4|種|しゅ|種類|禾重",
            "4|周|しゅう|周囲|", "4|祝|しゅく|祝日|ネ兄", "4|順|じゅん|順番|川頁", "4|初|しょ|最初|衣刀", "4|松|まつ|松|木公",
            "4|笑|わらう|笑顔|竹夭", "4|唱|しょう|合唱|口昌", "4|焼|やく|焼肉|火尭", "4|象|ぞう|象|", "4|照|てる|照明|日召灬",
            "4|賞|しょう|賞品|", "4|臣|しん|大臣|", "4|信|しん|信用|イ言", "4|成|せい|成功|", "4|省|しょう|反省|少目",
            "4|清|せい|清書|氵青", "4|静|せい|静か|青争", "4|席|せき|出席|广廿巾", "4|積|せき|面積|禾責", "4|折|おる|折紙|扌斤",
            "4|節|せつ|季節|竹即", "4|説|せつ|説明|言兑", "4|浅|あさい|浅い|氵戋", "4|戦|せん|戦争|単戈", "4|選|せん|選挙|辶巽",
            "4|然|ぜん|自然|", "4|争|そう|戦争|", "4|倉|そう|倉庫|", "4|巣|す|巣|", "4|束|たば|花束|木口",
            "4|側|がわ|側面|イ則", "4|続|ぞく|継続|糸売", "4|卒|そつ|卒業|", "4|孫|まご|子孫|子系", "4|帯|たい|地帯|",
            "4|隊|たい|軍隊|阝", "4|達|たつ|友達|辶土羊", "4|単|たん|簡単|", "4|置|おく|位置|罒直", "4|仲|なか|仲間|イ中",
            "4|貯|ちょ|貯金|貝宁", "4|兆|ちょう|兆|", "4|腸|ちょう|胃腸|月昜", "4|低|てい|低下|イ氏", "4|底|てい|海底|广氐",
            "4|停|てい|停止|イ亭", "4|的|てき|目的|白勺", "4|典|てん|辞典|", "4|伝|でん|伝言|イ云", "4|徒|と|生徒|彳走",
            "4|努|ど|努力|女又力", "4|灯|とう|灯台|火丁", "4|堂|どう|食堂|", "4|働|どう|労働|イ重力", "4|特|とく|特別|牛寺",
            "4|得|とく|得意|彳", "4|毒|どく|毒|", "4|熱|ねつ|熱|勢灬", "4|念|ねん|記念|今心", "4|敗|はい|失敗|貝攵",
            "4|梅|うめ|梅|木毎", "4|博|はく|博士|十甫寸", "4|飯|はん|御飯|飠反", "4|飛|とぶ|飛行|", "4|費|ひ|費用|弗貝",
            "4|必|ひつ|必要|心丿", "4|票|ひょう|投票|", "4|標|ひょう|目標|木票", "4|不|ふ|不足|", "4|夫|ふ|夫婦|",
            "4|付|ふ|受付|イ寸", "4|府|ふ|政府|广付", "4|副|ふく|副賞|畐刂", "4|粉|こな|小麦粉|米分", "4|兵|へい|兵隊|",
            "4|別|べつ|特別|", "4|辺|へん|周辺|辶刀", "4|変|へん|変化|亦攵", "4|便|べん|便利|イ更", "4|包|ほう|包帯|",
            "4|法|ほう|方法|氵去", "4|望|ぼう|希望|亡月王", "4|牧|ぼく|牧場|牛攵", "4|末|まつ|年末|", "4|満|まん|満足|氵",
            "4|未|み|未来|", "4|脈|みゃく|文脈|月", "4|民|みん|国民|", "4|無|む|無|", "4|約|やく|約束|糸勺",
            "4|勇|ゆう|勇気|マ男", "4|要|よう|必要|西女", "4|養|よう|養分|羊食", "4|浴|よく|入浴|氵谷", "4|利|り|便利|禾刂",
            "4|陸|りく|大陸|阝", "4|良|りょう|良好|", "4|料|りょう|料金|米斗", "4|量|りょう|分量|日里", "4|輪|りん|車輪|車",
            "4|類|るい|種類|米大頁", "4|令|れい|命令|", "4|冷|れい|冷房|冫令", "4|例|れい|例外|イ列", "4|歴|れき|歴史|厂禾",
            "4|連|れん|連続|辶車", "4|老|ろう|老人|", "4|労|ろう|労働|", "4|録|ろく|記録|金录",

            // 5年生
            "5|圧|あつ|圧力|厂土丶", "5|移|い|移動|禾多", "5|因|いん|原因|囗大", "5|永|えい|永久|", "5|営|えい|営業|",
            "5|衛|えい|衛星|行", "5|易|えき|貿易|日勿", "5|益|えき|利益|", "5|液|えき|液体|氵夜", "5|演|えん|演技|氵寅",
            "5|応|おう|応用|广心", "5|往|おう|往復|彳主", "5|桜|さくら|桜|木女", "5|恩|おん|恩返し|因心", "5|可|か|可能|",
            "5|仮|か|仮定|イ反", "5|価|か|価格|イ西", "5|河|か|河川|氵可", "5|過|か|過去|辶咼", "5|賀|が|年賀|加貝",
            "5|快|かい|快適|忄夬", "5|解|かい|正解|角刀牛", "5|格|かく|合格|木各", "5|確|かく|確認|石", "5|額|がく|金額|客頁",
            "5|刊|かん|刊行|", "5|幹|かん|新幹線|", "5|慣|かん|習慣|忄貫", "5|眼|がん|眼科|目艮", "5|基|き|基本|其土",
            "5|寄|き|寄付|ウ奇", "5|規|き|規則|夫見", "5|技|ぎ|技術|扌支", "5|義|ぎ|正義|羊我", "5|逆|ぎゃく|逆|辶",
            "5|久|ひさ|永久|", "5|旧|きゅう|復旧|l日", "5|居|きょ|住居|尸古", "5|許|きょ|許可|言午", "5|境|きょう|国境|土竟",
            "5|均|きん|平均|土匀", "5|禁|きん|禁止|林示", "5|句|く|句読点|", "5|群|ぐん|群衆|君羊", "5|経|けい|経済|糸圣",
            "5|潔|けつ|清潔|氵", "5|件|けん|事件|イ牛", "5|券|けん|券|", "5|険|けん|危険|阝僉", "5|検|けん|検査|木僉",
            "5|限|げん|限界|阝艮", "5|現|げん|現在|王見", "5|減|げん|減少|氵咸", "5|故|こ|事故|古攵", "5|個|こ|個人|イ固",
            "5|護|ご|弁護|言", "5|効|こう|効果|交力", "5|厚|こう|厚い|", "5|耕|こう|耕作|耒井", "5|鉱|こう|鉱物|金広",
            "5|構|こう|構造|木冓", "5|興|こう|興味|", "5|講|こう|講演|言冓", "5|混|こん|混雑|氵昆", "5|査|さ|調査|木旦",
            "5|再|さい|再開|", "5|災|さい|災害|", "5|妻|さい|妻子|", "5|採|さい|採点|扌采", "5|際|さい|国際|阝祭",
            "5|在|ざい|現在|", "5|財|ざい|財布|貝才", "5|罪|ざい|犯罪|罒非", "5|雑|ざつ|雑誌|", "5|酸|さん|酸素|酉",
            "5|賛|さん|賛成|", "5|支|し|支店|", "5|志|し|意志|士心", "5|枝|えだ|枝|木支", "5|師|し|教師|",
            "5|資|し|資料|次貝", "5|飼|し|飼育|食司", "5|示|じ|指示|", "5|似|にる|似顔絵|イ以", "5|識|しき|知識|言音戈",
            "5|質|しつ|質問|", "5|舎|しゃ|校舎|", "5|謝|しゃ|感謝|言射", "5|授|じゅ|授業|扌受", "5|修|しゅう|修理|イ",
            "5|述|じゅつ|記述|辶术", "5|術|じゅつ|技術|行术", "5|準|じゅん|準備|氵", "5|序|じょ|順序|广予", "5|招|しょう|招待|扌召",
            "5|承|しょう|承知|", "5|証|しょう|証明|言正", "5|条|じょう|条件|", "5|状|じょう|賞状|爿犬", "5|常|じょう|日常|",
            "5|情|じょう|感情|忄青", "5|織|しょく|組織|糸音戈", "5|職|しょく|職業|耳音戈", "5|制|せい|制度|", "5|性|せい|性格|忄生",
            "5|政|せい|政治|正攵", "5|勢|せい|勢い|", "5|精|せい|精神|米青", "5|製|せい|製品|", "5|税|ぜい|税金|禾兑",
            "5|責|せき|責任|", "5|績|せき|成績|糸責", "5|接|せつ|接近|扌妾", "5|設|せつ|設計|言殳", "5|舌|した|舌|",
            "5|絶|ぜつ|絶対|糸色", "5|銭|せん|金銭|金戋", "5|祖|そ|祖先|ネ且", "5|素|そ|酸素|", "5|総|そう|総合|糸",
            "5|造|ぞう|製造|辶告", "5|像|ぞう|仏像|イ象", "5|増|ぞう|増加|土曽", "5|則|そく|規則|貝刂", "5|測|そく|測定|氵則",
            "5|属|ぞく|所属|尸禹", "5|率|りつ|確率|", "5|損|そん|損害|扌員", "5|退|たい|退院|辶艮", "5|貸|かす|貸借|代貝",
            "5|態|たい|態度|能心", "5|団|だん|団体|囗寸", "5|断|だん|断定|", "5|築|ちく|建築|竹工", "5|張|ちょう|主張|弓長",
            "5|提|てい|提案|扌是", "5|程|てい|程度|禾呈", "5|適|てき|適切|辶啇", "5|敵|てき|敵|", "5|統|とう|統一|糸充",
            "5|銅|どう|銅|金同", "5|導|どう|指導|道寸", "5|徳|とく|道徳|彳", "5|独|どく|独身|犭虫", "5|任|にん|責任|イ壬",
            "5|燃|ねん|燃料|火然", "5|能|のう|能力|", "5|破|は|破壊|石皮", "5|犯|はん|犯罪|犭", "5|判|はん|判断|半刂",
            "5|版|はん|出版|片反", "5|比|ひ|比較|", "5|肥|ひ|肥料|月巴", "5|非|ひ|非常|", "5|備|び|準備|イ",
            "5|俵|ひょう|土俵|イ表", "5|評|ひょう|評判|言平", "5|貧|ひん|貧乏|分貝", "5|布|ふ|布団|", "5|婦|ふ|主婦|女帚",
            "5|富|ふ|富士|ウ", "5|武|ぶ|武器|止戈", "5|復|ふく|復習|彳复", "5|複|ふく|複数|衤复", "5|仏|ぶつ|仏像|イム",
            "5|編|へん|編集|糸扁", "5|弁|べん|弁当|", "5|保|ほ|保存|イ呆", "5|墓|はか|墓|土莫", "5|報|ほう|報告|",
            "5|豊|ほう|豊富|", "5|防|ぼう|防止|阝方", "5|貿|ぼう|貿易|卯貝", "5|暴|ぼう|暴力|日共", "5|務|む|義務|矛",
            "5|夢|ゆめ|夢|", "5|迷|めい|迷惑|米辶", "5|綿|めん|木綿|糸帛", "5|輸|ゆ|輸出|車人一月刂", "5|余|よ|余計|",
            "5|預|よ|預金|予頁", "5|容|よう|内容|ウ谷", "5|略|りゃく|省略|田各", "5|留|りゅう|留守|卯田", "5|領|りょう|大統領|令頁",

            // 6年生
            "6|異|い|異変|田共", "6|遺|い|遺産|辶貴", "6|域|いき|地域|土或", "6|宇|う|宇宙|ウ于", "6|映|えい|映画|日央",
            "6|延|えん|延長|廴正", "6|沿|えん|沿線|氵谷", "6|我|が|我々|", "6|灰|はい|灰色|", "6|拡|かく|拡大|扌広",
            "6|革|かく|改革|", "6|閣|かく|内閣|門各", "6|割|わり|割引|害刂", "6|株|かぶ|株式|木朱", "6|干|かん|干物|",
            "6|巻|かん|巻物|", "6|看|かん|看板|手目", "6|簡|かん|簡単|竹間", "6|危|き|危険|ク厂厄", "6|机|つくえ|机|木几",
            "6|揮|き|指揮|扌軍", "6|貴|き|貴重|", "6|疑|ぎ|疑問|ヒ矢マ疋", "6|吸|きゅう|呼吸|口及", "6|供|きょう|子供|イ共",
            "6|胸|きょう|胸|月匈", "6|郷|きょう|故郷|", "6|勤|きん|勤務|", "6|筋|きん|筋肉|竹肋", "6|系|けい|系統|",
            "6|敬|けい|敬語|苟攵", "6|警|けい|警察|敬言", "6|劇|げき|演劇|", "6|激|げき|感激|氵白放", "6|穴|あな|穴|ウ八",
            "6|絹|きぬ|絹|糸口月", "6|権|けん|権利|木", "6|憲|けん|憲法|", "6|源|げん|資源|氵原", "6|厳|げん|厳重|ツ厂敢",
            "6|己|こ|自己|", "6|呼|こ|呼吸|口乎", "6|誤|ご|誤解|言呉", "6|后|こう|皇后|", "6|孝|こう|親孝行|土子",
            "6|皇|こう|天皇|白王", "6|紅|こう|紅白|糸工", "6|降|こう|降車|阝夅", "6|鋼|こう|鉄鋼|金岡", "6|刻|こく|時刻|亥刂",
            "6|穀|こく|穀物|", "6|骨|ほね|骨|", "6|困|こん|困難|囗木", "6|砂|すな|砂|石少", "6|座|ざ|座席|广坐",
            "6|済|さい|返済|氵斉", "6|裁|さい|裁判|衣", "6|策|さく|対策|竹", "6|冊|さつ|冊子|", "6|蚕|さん|蚕|天虫",
            "6|至|し|至急|", "6|私|わたくし|私|禾ム", "6|姿|し|姿勢|次女", "6|視|し|視力|ネ見", "6|詞|し|歌詞|言司",
            "6|誌|し|雑誌|言志", "6|磁|じ|磁石|石兹", "6|射|しゃ|注射|身寸", "6|捨|しゃ|捨てる|扌舎", "6|尺|しゃく|尺度|",
            "6|若|じゃく|若い|艹右", "6|樹|じゅ|樹木|木喜寸", "6|収|しゅう|収集|", "6|宗|しゅう|宗教|ウ示", "6|就|しゅう|就職|京尤",
            "6|衆|しゅう|群衆|血", "6|従|じゅう|従う|彳", "6|縦|じゅう|縦書き|糸従", "6|縮|しゅく|短縮|糸宿", "6|熟|じゅく|熟語|",
            "6|純|じゅん|単純|糸屯", "6|処|しょ|処理|夂", "6|署|しょ|署名|罒者", "6|諸|しょ|諸君|言者", "6|除|じょ|掃除|阝余",
            "6|将|しょう|将棋|", "6|傷|しょう|負傷|イ", "6|障|しょう|故障|阝章", "6|城|じょう|城|土成", "6|蒸|じょう|蒸気|艹",
            "6|針|はり|針|金十", "6|仁|じん|仁義|イ二", "6|垂|すい|垂直|", "6|推|すい|推理|扌隹", "6|寸|すん|寸法|",
            "6|盛|せい|盛大|成皿", "6|聖|せい|神聖|耳口王", "6|誠|せい|誠実|言成", "6|宣|せん|宣伝|ウ亘", "6|専|せん|専門|",
            "6|泉|せん|温泉|白水", "6|洗|せん|洗濯|氵先", "6|染|せん|染色|氵九木", "6|善|ぜん|善悪|羊口口", "6|奏|そう|演奏|天",
            "6|窓|まど|窓|ウ", "6|創|そう|創作|倉刂", "6|装|そう|服装|壮衣", "6|層|そう|地層|尸曽", "6|操|そう|体操|扌品木",
            "6|蔵|ぞう|貯蔵|艹厂臣", "6|臓|ぞう|心臓|月蔵", "6|存|そん|保存|", "6|尊|そん|尊敬|酋寸", "6|宅|たく|自宅|ウ",
            "6|担|たん|担当|扌旦", "6|探|たん|探検|扌罙", "6|誕|たん|誕生|言延", "6|段|だん|階段|", "6|暖|だん|暖房|日爰",
            "6|値|ち|価値|イ直", "6|宙|ちゅう|宇宙|ウ由", "6|忠|ちゅう|忠実|中心", "6|著|ちょ|著者|艹者", "6|庁|ちょう|県庁|广丁",
            "6|頂|ちょう|頂上|丁頁", "6|潮|ちょう|潮|氵朝", "6|賃|ちん|家賃|任貝", "6|痛|つう|痛い|疒", "6|展|てん|展示|",
            "6|討|とう|検討|言寸", "6|党|とう|政党|", "6|糖|とう|砂糖|米唐", "6|届|とどく|届く|尸由", "6|難|なん|困難|",
            "6|乳|にゅう|牛乳|", "6|認|にん|確認|言忍", "6|納|のう|納得|糸内", "6|脳|のう|頭脳|月", "6|派|は|派手|氵",
            "6|拝|はい|拝見|扌", "6|背|はい|背中|北月", "6|肺|はい|肺|月市", "6|俳|はい|俳句|イ非", "6|班|はん|班長|王王",
            "6|晩|ばん|今晩|日免", "6|否|ひ|否定|口不", "6|批|ひ|批判|扌比", "6|秘|ひ|秘密|禾必", "6|腹|ふく|空腹|月复",
            "6|奮|ふん|興奮|大田力", "6|並|へい|並列|", "6|陛|へい|陛下|阝", "6|閉|へい|閉会|門オ", "6|片|へん|片道|",
            "6|補|ほ|補習|衤甫", "6|暮|ぼ|夕暮れ|艹日大", "6|宝|ほう|宝物|ウ玉", "6|訪|ほう|訪問|言方", "6|亡|ぼう|死亡|",
            "6|忘|ぼう|忘れる|亡心", "6|棒|ぼう|鉄棒|木奉", "6|枚|まい|枚数|木攵", "6|幕|まく|開幕|", "6|密|みつ|秘密|ウ必山",
            "6|盟|めい|同盟|明皿", "6|模|も|模型|木莫", "6|訳|やく|翻訳|言尺", "6|郵|ゆう|郵便|垂阝", "6|優|ゆう|優勝|イ憂",
            "6|幼|よう|幼児|幺力", "6|欲|よく|欲|谷欠", "6|翌|よく|翌日|羽立", "6|乱|らん|混乱|舌", "6|卵|らん|卵|卯丶丶",
            "6|覧|らん|展覧会|", "6|裏|うら|裏口|里", "6|律|りつ|法律|彳聿", "6|臨|りん|臨時|", "6|朗|ろう|朗読|良月",
            "6|論|ろん|理論|言侖",
        ];

        // データをパースする関数
        const parseData = () => {
            return COMPRESSED_DATA.map(line => {
                const [g, k, r, m, p] = line.split('|');
                const parts = p ? p.split('') : [];
                return {
                    grade: parseInt(g, 10),
                    kanji: k,
                    reading: r,
                    meaning: m,
                    parts: parts
                };
            });
        };

        const KANJI_DATA = parseData();

        // ユーティリティ: 意味テキストから正解の漢字を隠す
        const getMaskedMeaning = (meaning, kanji) => {
            if (!meaning || !kanji) return "";
            return meaning.split(kanji).join('□');
        };

        const App = () => {
            const [currentScreen, setCurrentScreen] = useState('title'); 
            const [selectedGrade, setSelectedGrade] = useState(null);
            const [gameMode, setGameMode] = useState(null); 
            const [score, setScore] = useState(0);
            const [questions, setQuestions] = useState([]);
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);

            const startGame = (grade, mode) => {
                setSelectedGrade(grade);
                setGameMode(mode);
                setScore(0);
                setCurrentQuestionIndex(0);

                let filtered = KANJI_DATA.filter(k => k.grade === grade);

                if (mode === 'puzzle') {
                    filtered = filtered.filter(k => k.parts.length >= 2);
                } else {
                    filtered = filtered.filter(k => k.reading);
                }

                if (filtered.length < 5) {
                    alert("この学年・モードの問題データが不足しています。");
                    return;
                }

                const shuffled = [...filtered].sort(() => 0.5 - Math.random());
                setQuestions(shuffled.slice(0, 5));

                setCurrentScreen(mode === 'reading' ? 'gameReading' : 'gamePuzzle');
            };

            const returnToTitle = () => {
                setCurrentScreen('title');
                setSelectedGrade(null);
                setGameMode(null);
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-2xl bg-white shadow-xl rounded-3xl overflow-hidden border-4 border-stone-200">
                        
                        <div className="bg-indigo-600 p-4 flex justify-between items-center text-white">
                            <div className="flex items-center gap-2 font-bold text-xl">
                                <GraduationCap />
                                <span>漢字マスター道場 <span className="text-yellow-300 text-sm ml-1">極</span></span>
                            </div>
                            {currentScreen !== 'title' && (
                                <button onClick={returnToTitle} className="p-2 hover:bg-indigo-500 rounded-full transition">
                                    <Home size={20} />
                                </button>
                            )}
                        </div>

                        <div className="p-6 min-h-[400px] flex flex-col">
                            
                            {currentScreen === 'title' && (
                                <div className="flex flex-col items-center justify-center h-full gap-8 animate-fadeIn">
                                    <div className="text-center">
                                        <h1 className="text-4xl md:text-5xl font-extrabold text-indigo-800 mb-4 tracking-wider">
                                            漢字<span className="text-red-500">道</span>場<br/>
                                            <span className="text-2xl text-yellow-500 mt-2 block">〜極（きわみ）〜</span>
                                        </h1>
                                        <p className="text-stone-500 text-lg">全学年対応！漢字を極めよう</p>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 w-full max-w-md">
                                        <div className="bg-orange-100 p-4 rounded-xl flex flex-col items-center border-2 border-orange-200">
                                            <BookOpen size={40} className="text-orange-500 mb-2" />
                                            <span className="font-bold">読み練習</span>
                                            <span className="text-xs text-stone-500 mt-1">全漢字対応</span>
                                        </div>
                                        <div className="bg-emerald-100 p-4 rounded-xl flex flex-col items-center border-2 border-emerald-200">
                                            <Puzzle size={40} className="text-emerald-500 mb-2" />
                                            <span className="font-bold">組み立て</span>
                                            <span className="text-xs text-stone-500 mt-1">対応漢字のみ</span>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={() => setCurrentScreen('gradeSelect')}
                                        className="bg-indigo-600 hover:bg-indigo-700 text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg transform transition hover:scale-105 flex items-center gap-2"
                                    >
                                        修業を始める <ArrowRight />
                                    </button>
                                </div>
                            )}

                            {currentScreen === 'gradeSelect' && (
                                <div className="flex flex-col h-full animate-fadeIn">
                                    <h2 className="text-2xl font-bold text-center mb-6 text-stone-700">学年を選んでください</h2>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4 flex-grow">
                                        {[1, 2, 3, 4, 5, 6].map((g) => (
                                            <button
                                                key={g}
                                                onClick={() => { setSelectedGrade(g); setCurrentScreen('modeSelect'); }}
                                                className="bg-white border-2 border-stone-200 hover:border-indigo-500 hover:bg-indigo-50 rounded-2xl p-6 flex flex-col items-center justify-center gap-2 transition shadow-sm hover:shadow-md group"
                                            >
                                                <span className="text-4xl font-black text-stone-300 group-hover:text-indigo-500 transition">{g}</span>
                                                <span className="text-sm font-bold text-stone-600">年生</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {currentScreen === 'modeSelect' && (
                                <div className="flex flex-col h-full animate-fadeIn">
                                    <h2 className="text-2xl font-bold text-center mb-2 text-stone-700">{selectedGrade}年生の特訓</h2>
                                    <p className="text-center text-stone-500 mb-8">モードを選んでください</p>
                                    
                                    <div className="grid gap-6 flex-grow">
                                        <button 
                                            onClick={() => startGame(selectedGrade, 'reading')}
                                            className="relative bg-gradient-to-r from-orange-400 to-orange-500 text-white rounded-2xl p-6 shadow-lg transform transition hover:-translate-y-1 hover:shadow-xl text-left flex items-center justify-between overflow-hidden"
                                        >
                                            <div className="z-10">
                                                <h3 className="text-2xl font-bold mb-1">読みの特訓</h3>
                                                <p className="opacity-90 text-sm">正しい読み方を選ぼう</p>
                                            </div>
                                            <BookOpen size={64} className="opacity-20 absolute right-4 bottom-[-10px]" />
                                            <ArrowRight className="z-10" />
                                        </button>

                                        <button 
                                            onClick={() => startGame(selectedGrade, 'puzzle')}
                                            className="relative bg-gradient-to-r from-emerald-400 to-emerald-500 text-white rounded-2xl p-6 shadow-lg transform transition hover:-translate-y-1 hover:shadow-xl text-left flex items-center justify-between overflow-hidden"
                                        >
                                            <div className="z-10">
                                                <h3 className="text-2xl font-bold mb-1">漢字組み立て</h3>
                                                <p className="opacity-90 text-sm">パーツを合わせて漢字を作ろう</p>
                                            </div>
                                            <Puzzle size={64} className="opacity-20 absolute right-4 bottom-[-10px]" />
                                            <ArrowRight className="z-10" />
                                        </button>
                                    </div>
                                    
                                    <button onClick={() => setCurrentScreen('gradeSelect')} className="mt-6 text-stone-400 hover:text-stone-600 text-sm font-bold self-center">
                                        戻る
                                    </button>
                                </div>
                            )}

                            {currentScreen === 'gameReading' && (
                                <ReadingGame 
                                    questions={questions} 
                                    currentIndex={currentQuestionIndex}
                                    score={score}
                                    setScore={setScore}
                                    onNext={(idx) => setCurrentQuestionIndex(idx)}
                                    onFinish={() => setCurrentScreen('result')}
                                    allData={KANJI_DATA}
                                />
                            )}

                            {currentScreen === 'gamePuzzle' && (
                                <PuzzleGame 
                                    questions={questions}
                                    currentIndex={currentQuestionIndex}
                                    score={score}
                                    setScore={setScore}
                                    onNext={(idx) => setCurrentQuestionIndex(idx)}
                                    onFinish={() => setCurrentScreen('result')}
                                    allData={KANJI_DATA}
                                />
                            )}

                            {currentScreen === 'result' && (
                                <div className="flex flex-col items-center justify-center h-full animate-fadeIn">
                                    <div className="mb-6 relative">
                                        <Trophy size={100} className={score === questions.length * 20 ? "text-yellow-400 animate-bounce" : "text-stone-300"} />
                                        {score === questions.length * 20 && <Star size={40} className="text-yellow-400 absolute top-0 right-[-20px] animate-spin-slow" fill="currentColor" />}
                                    </div>
                                    
                                    <h2 className="text-3xl font-bold text-stone-700 mb-2">特訓終了！</h2>
                                    <div className="text-5xl font-black text-indigo-600 mb-8 flex items-baseline gap-2">
                                        {score} <span className="text-xl text-stone-400 font-bold">/ {questions.length * 20}点</span>
                                    </div>

                                    <div className="grid gap-4 w-full max-w-xs">
                                        <button 
                                            onClick={() => startGame(selectedGrade, gameMode)}
                                            className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow flex items-center justify-center gap-2 transition"
                                        >
                                            <RefreshCcw size={20} /> もう一度挑戦
                                        </button>
                                        <button 
                                            onClick={returnToTitle}
                                            className="bg-white hover:bg-stone-50 text-stone-600 border-2 border-stone-200 font-bold py-3 rounded-xl shadow-sm flex items-center justify-center gap-2 transition"
                                        >
                                            <Home size={20} /> トップへ戻る
                                        </button>
                                    </div>
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        };

        const ReadingGame = ({ questions, currentIndex, score, setScore, onNext, onFinish, allData }) => {
            const currentQ = questions[currentIndex];
            const [selected, setSelected] = useState(null);
            const [isCorrect, setIsCorrect] = useState(null);
            const [choices, setChoices] = useState([]);

            useEffect(() => {
                if (!currentQ) return;
                const sameGrade = allData.filter(k => k.grade === currentQ.grade && k.reading !== currentQ.reading);
                let candidates = sameGrade;
                if (candidates.length < 3) {
                    candidates = allData.filter(k => k.reading !== currentQ.reading);
                }
                const shuffledOthers = candidates.sort(() => 0.5 - Math.random()).slice(0, 3);
                const finalChoices = [...shuffledOthers.map(k => k.reading), currentQ.reading].sort(() => 0.5 - Math.random());
                setChoices(finalChoices);
                setSelected(null);
                setIsCorrect(null);
            }, [currentQ]);

            const handleAnswer = (choice) => {
                if (selected) return;
                setSelected(choice);
                const correct = choice === currentQ.reading;
                setIsCorrect(correct);
                if (correct) setScore(s => s + 20);
                setTimeout(() => {
                    if (currentIndex < questions.length - 1) onNext(currentIndex + 1);
                    else onFinish();
                }, 1500);
            };

            return (
                <div className="flex flex-col h-full max-w-md mx-auto w-full">
                    <div className="flex justify-between items-center mb-2 px-2">
                        <div className="flex gap-1">
                        {Array.from({length: questions.length}).map((_, i) => (
                            <div key={i} className={`h-2 w-6 rounded-full ${i < currentIndex + 1 ? 'bg-indigo-500' : 'bg-stone-200'}`} />
                        ))}
                        </div>
                        <div className="font-bold text-indigo-600 flex items-center gap-1"><Star size={16} fill="currentColor" /> {score}</div>
                    </div>
                    
                    <div className="flex-grow flex flex-col items-center justify-center py-4">
                        <div className="bg-stone-800 text-white rounded-3xl w-48 h-48 flex items-center justify-center text-7xl font-serif shadow-2xl mb-6 relative overflow-hidden">
                            {currentQ.kanji}
                            {isCorrect === true && <div className="absolute inset-0 bg-green-500/30 flex items-center justify-center animate-pulse"><CheckCircle size={80} className="text-white" /></div>}
                            {isCorrect === false && <div className="absolute inset-0 bg-red-500/30 flex items-center justify-center animate-pulse"><XCircle size={80} className="text-white" /></div>}
                        </div>
                        <p className="text-stone-500 font-bold mb-4 bg-stone-100 px-4 py-1 rounded-full text-sm">
                            意味: {getMaskedMeaning(currentQ.meaning, currentQ.kanji)}
                        </p>
                    </div>

                    <div className="grid grid-cols-2 gap-3 mb-4">
                        {choices.map((choice, idx) => {
                            let btnClass = "py-4 px-2 rounded-xl font-bold text-lg transition border-b-4 active:border-b-0 active:translate-y-1 ";
                            if (selected === null) btnClass += "bg-white text-stone-700 border-stone-200 hover:bg-indigo-50 hover:border-indigo-300";
                            else if (choice === currentQ.reading) btnClass += "bg-green-500 text-white border-green-700";
                            else if (choice === selected && !isCorrect) btnClass += "bg-red-500 text-white border-red-700";
                            else btnClass += "bg-stone-100 text-stone-300 border-stone-200";
                            return (
                                <button key={idx} onClick={() => handleAnswer(choice)} className={btnClass} disabled={selected !== null}>{choice}</button>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const PuzzleGame = ({ questions, currentIndex, score, setScore, onNext, onFinish, allData }) => {
            const currentQ = questions[currentIndex];
            const [selectedParts, setSelectedParts] = useState([]);
            const [isCorrect, setIsCorrect] = useState(null);
            const [partsPool, setPartsPool] = useState([]);

            useEffect(() => {
                if (!currentQ) return;
                const hasPartsData = allData.filter(k => k.parts && k.parts.length > 0);
                const allParts = hasPartsData.flatMap(k => k.parts);
                const correctParts = currentQ.parts;
                const uniqueParts = [...new Set(allParts)];
                const distractors = uniqueParts.filter(p => !correctParts.includes(p)).sort(() => 0.5 - Math.random()).slice(0, 5);
                const pool = [...correctParts, ...distractors].sort(() => 0.5 - Math.random());
                setPartsPool(pool.map((p, i) => ({ id: i, char: p }))); 
                setSelectedParts([]);
                setIsCorrect(null);
            }, [currentQ]);

            const handleSelectPart = (part) => {
                if (isCorrect !== null) return;
                if (selectedParts.some(p => p.id === part.id)) setSelectedParts(prev => prev.filter(p => p.id !== part.id));
                else setSelectedParts(prev => [...prev, part]);
            };

            const checkAnswer = () => {
                const selectedChars = selectedParts.map(p => p.char).sort();
                const correctChars = [...currentQ.parts].sort();
                const correct = JSON.stringify(selectedChars) === JSON.stringify(correctChars);
                setIsCorrect(correct);
                if (correct) {
                    setScore(s => s + 20);
                    setTimeout(() => {
                        if (currentIndex < questions.length - 1) onNext(currentIndex + 1);
                        else onFinish();
                    }, 1500);
                } else {
                    setTimeout(() => {
                        setIsCorrect(null);
                        setSelectedParts([]);
                    }, 1000);
                }
            };

            return (
                <div className="flex flex-col h-full max-w-md mx-auto w-full">
                    <div className="flex justify-between items-center mb-2 px-2">
                        <div className="flex gap-1">
                        {Array.from({length: questions.length}).map((_, i) => (
                            <div key={i} className={`h-2 w-6 rounded-full ${i < currentIndex + 1 ? 'bg-indigo-500' : 'bg-stone-200'}`} />
                        ))}
                        </div>
                        <div className="font-bold text-indigo-600 flex items-center gap-1"><Star size={16} fill="currentColor" /> {score}</div>
                    </div>

                    <div className="flex-grow flex flex-col items-center py-2">
                        <div className="text-center mb-6">
                            <p className="text-stone-500 text-sm font-bold mb-1">この意味・読みの漢字を作れ！</p>
                            <div className="bg-stone-100 px-6 py-3 rounded-xl border-2 border-stone-200">
                                <div className="text-xl font-bold text-indigo-600 mb-1">{currentQ.reading}</div>
                                <div className="text-sm text-stone-600">{getMaskedMeaning(currentQ.meaning, currentQ.kanji)}</div>
                            </div>
                        </div>

                        <div className="flex items-center gap-2 mb-8 min-h-[80px]">
                            {currentQ.parts.map((_, i) => (
                                <div key={i} className={`w-14 h-14 rounded-lg border-2 border-dashed flex items-center justify-center text-2xl font-serif bg-stone-50 ${selectedParts[i] ? 'border-indigo-500 text-indigo-600 bg-indigo-50 border-solid' : 'border-stone-300 text-stone-300'}`}>
                                    {selectedParts[i]?.char}
                                </div>
                            ))}
                            <div className="text-stone-400 font-bold">=</div>
                            <div className={`w-16 h-16 rounded-lg flex items-center justify-center text-4xl font-serif transition-all duration-500 ${isCorrect === true ? 'bg-indigo-600 text-white rotate-[360deg]' : 'bg-stone-200 text-stone-300'}`}>
                                {isCorrect === true ? currentQ.kanji : "?"}
                            </div>
                        </div>

                        <div className="flex flex-wrap justify-center gap-3">
                            {partsPool.map((part) => {
                                const isSelected = selectedParts.some(p => p.id === part.id);
                                return (
                                    <button key={part.id} onClick={() => handleSelectPart(part)} disabled={isCorrect === true} className={`w-12 h-12 rounded-lg font-serif text-xl font-bold shadow-sm border-b-4 transition active:border-b-0 active:translate-y-1 ${isSelected ? 'bg-stone-300 text-stone-100 border-stone-400 translate-y-1 border-b-0' : 'bg-white text-stone-700 border-stone-200 hover:border-indigo-300'}`}>
                                        {part.char}
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    <button onClick={checkAnswer} disabled={selectedParts.length === 0 || isCorrect !== null} className={`w-full py-4 rounded-xl font-bold text-lg text-white shadow-lg transition ${selectedParts.length === 0 ? 'bg-stone-300 cursor-not-allowed' : isCorrect === false ? 'bg-red-500 animate-shake' : 'bg-indigo-600 hover:bg-indigo-700'}`}>
                        {isCorrect === true ? '正解！' : isCorrect === false ? 'ちがうよ！' : '合体させる！'}
                    </button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>